#!/bin/bash
set -e -o pipefail

apt-get update

exec 3> spec.new

echo "#!/bin/bash" >&3
cat spec.main >&3 

fetch_pkg(){
  local pkg="$1"

  info=$(apt-get --print-uris download "$pkg")
  if [ "$?" -ne 0 ]; then
    return 1
  fi
  url=$(echo "$info" | sed "s/^[^']*'\([^']*\)'.*$/\1/" | sed 's/^.*\(pool.*\)$/\1/')
  sum=$(echo "$info" | sed 's/^.*SHA256:\([^ ]*\) *.*$/\1/')
  printf 'SRCS="$SRCS file::rename=dist_%s.deb::${_mirror}/%s \\\n"\n' "$pkg" "$url"
  printf 'CHKSUMS="$CHKSUMS sha256::%s \\\n"\n' "$sum"
}

while read pkg; do
    if [ -z "$pkg" ]; then 
        continue
    fi
    fetch_pkg "$pkg" >&3
    fetch_pkg "$pkg-dbgsym" >&3 || fetch_pkg "$pkg-dbg" >&3
done < manifest

exec 3>&-
mv spec.new spec
