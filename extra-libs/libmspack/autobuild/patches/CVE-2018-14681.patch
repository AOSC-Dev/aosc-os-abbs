From 0b0ef9344255ff5acfac6b7af09198ac9c9756c8 Mon Sep 17 00:00:00 2001
From: Stuart Caie <kyzer@cabextract.org.uk>
Date: Sun, 26 Nov 2017 14:28:54 +0000
Subject: [PATCH] kwaj_read_headers(): fix handling of non-terminated strings

---
 ChangeLog                     |   8 +++
 Makefile.am                   |   4 +-
 mspack/kwajd.c                |  32 ++++++----
 test/kwajd_test.c             | 116 ++++++++++++++++++++++++++++++++++
 test/test_files/kwajd/f00.kwj | Bin 0 -> 15 bytes
 test/test_files/kwajd/f01.kwj | Bin 0 -> 17 bytes
 test/test_files/kwajd/f02.kwj | Bin 0 -> 18 bytes
 test/test_files/kwajd/f03.kwj | Bin 0 -> 19 bytes
 test/test_files/kwajd/f04.kwj | Bin 0 -> 19 bytes
 test/test_files/kwajd/f10.kwj | Bin 0 -> 17 bytes
 test/test_files/kwajd/f11.kwj | Bin 0 -> 19 bytes
 test/test_files/kwajd/f12.kwj | Bin 0 -> 20 bytes
 test/test_files/kwajd/f13.kwj | Bin 0 -> 21 bytes
 test/test_files/kwajd/f14.kwj | Bin 0 -> 21 bytes
 test/test_files/kwajd/f20.kwj | Bin 0 -> 18 bytes
 test/test_files/kwajd/f21.kwj | Bin 0 -> 20 bytes
 test/test_files/kwajd/f22.kwj | Bin 0 -> 21 bytes
 test/test_files/kwajd/f23.kwj | Bin 0 -> 22 bytes
 test/test_files/kwajd/f24.kwj | Bin 0 -> 22 bytes
 test/test_files/kwajd/f30.kwj | Bin 0 -> 19 bytes
 test/test_files/kwajd/f31.kwj | Bin 0 -> 21 bytes
 test/test_files/kwajd/f32.kwj | Bin 0 -> 22 bytes
 test/test_files/kwajd/f33.kwj | Bin 0 -> 23 bytes
 test/test_files/kwajd/f34.kwj | Bin 0 -> 23 bytes
 test/test_files/kwajd/f40.kwj | Bin 0 -> 20 bytes
 test/test_files/kwajd/f41.kwj | Bin 0 -> 22 bytes
 test/test_files/kwajd/f42.kwj | Bin 0 -> 23 bytes
 test/test_files/kwajd/f43.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f44.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f50.kwj | Bin 0 -> 21 bytes
 test/test_files/kwajd/f51.kwj | Bin 0 -> 23 bytes
 test/test_files/kwajd/f52.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f53.kwj | Bin 0 -> 25 bytes
 test/test_files/kwajd/f54.kwj | Bin 0 -> 25 bytes
 test/test_files/kwajd/f60.kwj | Bin 0 -> 22 bytes
 test/test_files/kwajd/f61.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f62.kwj | Bin 0 -> 25 bytes
 test/test_files/kwajd/f63.kwj | Bin 0 -> 26 bytes
 test/test_files/kwajd/f64.kwj | Bin 0 -> 26 bytes
 test/test_files/kwajd/f70.kwj | Bin 0 -> 23 bytes
 test/test_files/kwajd/f71.kwj | Bin 0 -> 25 bytes
 test/test_files/kwajd/f72.kwj | Bin 0 -> 26 bytes
 test/test_files/kwajd/f73.kwj | Bin 0 -> 27 bytes
 test/test_files/kwajd/f74.kwj | Bin 0 -> 27 bytes
 test/test_files/kwajd/f80.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f81.kwj | Bin 0 -> 26 bytes
 test/test_files/kwajd/f82.kwj | Bin 0 -> 27 bytes
 test/test_files/kwajd/f83.kwj | Bin 0 -> 28 bytes
 test/test_files/kwajd/f84.kwj | Bin 0 -> 28 bytes
 test/test_files/kwajd/f90.kwj | Bin 0 -> 24 bytes
 test/test_files/kwajd/f91.kwj | Bin 0 -> 26 bytes
 test/test_files/kwajd/f92.kwj | Bin 0 -> 27 bytes
 test/test_files/kwajd/f93.kwj | Bin 0 -> 28 bytes
 test/test_files/kwajd/f94.kwj | Bin 0 -> 28 bytes
 test/test_files/kwajd/make.pl |  17 +++++
 55 files changed, 163 insertions(+), 14 deletions(-)
 create mode 100644 test/kwajd_test.c
 create mode 100644 test/test_files/kwajd/f00.kwj
 create mode 100644 test/test_files/kwajd/f01.kwj
 create mode 100644 test/test_files/kwajd/f02.kwj
 create mode 100644 test/test_files/kwajd/f03.kwj
 create mode 100644 test/test_files/kwajd/f04.kwj
 create mode 100644 test/test_files/kwajd/f10.kwj
 create mode 100644 test/test_files/kwajd/f11.kwj
 create mode 100644 test/test_files/kwajd/f12.kwj
 create mode 100644 test/test_files/kwajd/f13.kwj
 create mode 100644 test/test_files/kwajd/f14.kwj
 create mode 100644 test/test_files/kwajd/f20.kwj
 create mode 100644 test/test_files/kwajd/f21.kwj
 create mode 100644 test/test_files/kwajd/f22.kwj
 create mode 100644 test/test_files/kwajd/f23.kwj
 create mode 100644 test/test_files/kwajd/f24.kwj
 create mode 100644 test/test_files/kwajd/f30.kwj
 create mode 100644 test/test_files/kwajd/f31.kwj
 create mode 100644 test/test_files/kwajd/f32.kwj
 create mode 100644 test/test_files/kwajd/f33.kwj
 create mode 100644 test/test_files/kwajd/f34.kwj
 create mode 100644 test/test_files/kwajd/f40.kwj
 create mode 100644 test/test_files/kwajd/f41.kwj
 create mode 100644 test/test_files/kwajd/f42.kwj
 create mode 100644 test/test_files/kwajd/f43.kwj
 create mode 100644 test/test_files/kwajd/f44.kwj
 create mode 100644 test/test_files/kwajd/f50.kwj
 create mode 100644 test/test_files/kwajd/f51.kwj
 create mode 100644 test/test_files/kwajd/f52.kwj
 create mode 100644 test/test_files/kwajd/f53.kwj
 create mode 100644 test/test_files/kwajd/f54.kwj
 create mode 100644 test/test_files/kwajd/f60.kwj
 create mode 100644 test/test_files/kwajd/f61.kwj
 create mode 100644 test/test_files/kwajd/f62.kwj
 create mode 100644 test/test_files/kwajd/f63.kwj
 create mode 100644 test/test_files/kwajd/f64.kwj
 create mode 100644 test/test_files/kwajd/f70.kwj
 create mode 100644 test/test_files/kwajd/f71.kwj
 create mode 100644 test/test_files/kwajd/f72.kwj
 create mode 100644 test/test_files/kwajd/f73.kwj
 create mode 100644 test/test_files/kwajd/f74.kwj
 create mode 100644 test/test_files/kwajd/f80.kwj
 create mode 100644 test/test_files/kwajd/f81.kwj
 create mode 100644 test/test_files/kwajd/f82.kwj
 create mode 100644 test/test_files/kwajd/f83.kwj
 create mode 100644 test/test_files/kwajd/f84.kwj
 create mode 100644 test/test_files/kwajd/f90.kwj
 create mode 100644 test/test_files/kwajd/f91.kwj
 create mode 100644 test/test_files/kwajd/f92.kwj
 create mode 100644 test/test_files/kwajd/f93.kwj
 create mode 100644 test/test_files/kwajd/f94.kwj
 create mode 100755 test/test_files/kwajd/make.pl

diff --git a/ChangeLog b/ChangeLog
index 3f436cc..8d9ed07 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -8,6 +8,14 @@
 	* chmd_read_headers(): reject files with blank filenames. Thanks
 	again to Hanno BÃ¶ck for finding the issue and providing a sample file.
 
+2017-11-26  Stuart Caie <kyzer@cabextract.org.uk>
+
+	* kwajd_read_headers(): fix up the logic of reading the filename and
+	extension headers to avoid a one or two byte overwrite. Thanks to
+	Jakub Wilk for finding the issue.
+
+	* test/kwajd_test.c: add tests for KWAJ filename.ext handling
+
 2017-08-13  Stuart Caie <kyzer@cabextract.org.uk>
 
 	* src/chmextract.c: support MinGW one-arg mkdir(). Thanks to AntumDeluge
diff --git a/Makefile.am b/Makefile.am
index d25dd32..e2d0c96 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -24,7 +24,7 @@ lib_LTLIBRARIES =	libmspack.la
 noinst_LTLIBRARIES =	libmscabd.la libmschmd.la
 noinst_PROGRAMS =	examples/cabd_memory examples/multifh test/cabd_md5 \
 			test/cabd_test test/chmd_find test/chmd_md5 \
-			test/chmd_order test/chminfo
+			test/chmd_order test/chminfo test/kwajd_test
 
 libmspack_la_SOURCES =	mspack/mspack.h \
 			mspack/system.h mspack/system.c \
@@ -89,3 +89,5 @@ test_chmd_order_SOURCES =	test/chmd_order.c test/md5.c test/md5.h \
 test_chmd_order_LDADD =		libmschmd.la
 test_chminfo_SOURCES =		test/chminfo.c libmschmd.la
 test_chminfo_LDADD =		libmschmd.la
+test_kwajd_test_SOURCES =	test/kwajd_test.c libmspack.la
+test_kwajd_test_LDADD = 	libmspack.la
diff --git a/mspack/kwajd.c b/mspack/kwajd.c
index c9e006c..50be257 100644
--- a/mspack/kwajd.c
+++ b/mspack/kwajd.c
@@ -198,30 +198,36 @@ static int kwajd_read_headers(struct mspack_system *sys,
 
     /* filename and extension */
     if (hdr->headers & (MSKWAJ_HDR_HASFILENAME | MSKWAJ_HDR_HASFILEEXT)) {
-	off_t pos = sys->tell(fh);
-	char *fn = (char *) sys->alloc(sys, (size_t) 13);
-
+	int len;
 	/* allocate memory for maximum length filename */
-	if (! fn) return MSPACK_ERR_NOMEMORY;
-	hdr->filename = fn;
+	char *fn = (char *) sys->alloc(sys, (size_t) 13);
+	if (!(hdr->filename = fn)) return MSPACK_ERR_NOMEMORY;
 
 	/* copy filename if present */
 	if (hdr->headers & MSKWAJ_HDR_HASFILENAME) {
-	    if (sys->read(fh, &buf[0], 9) != 9) return MSPACK_ERR_READ;
-	    for (i = 0; i < 9; i++, fn++) if (!(*fn = buf[i])) break;
-	    pos += (i < 9) ? i+1 : 9;
-	    if (sys->seek(fh, pos, MSPACK_SYS_SEEK_START))
+	    /* read and copy up to 9 bytes of a null terminated string */
+	    if ((len = sys->read(fh, &buf[0], 9)) < 2) return MSPACK_ERR_READ;
+	    for (i = 0; i < len; i++) if (!(*fn++ = buf[i])) break;
+	    /* if string was 9 bytes with no null terminator, reject it */
+	    if (i == 9 && buf[8] != '\0') return MSPACK_ERR_DATAFORMAT;
+	    /* seek to byte after string ended in file */
+	    if (sys->seek(fh, (off_t)(i + 1 - len), MSPACK_SYS_SEEK_CUR))
 		return MSPACK_ERR_SEEK;
+	    fn--; /* remove the null terminator */
 	}
 
 	/* copy extension if present */
 	if (hdr->headers & MSKWAJ_HDR_HASFILEEXT) {
 	    *fn++ = '.';
-	    if (sys->read(fh, &buf[0], 4) != 4) return MSPACK_ERR_READ;
-	    for (i = 0; i < 4; i++, fn++) if (!(*fn = buf[i])) break;
-	    pos += (i < 4) ? i+1 : 4;
-	    if (sys->seek(fh, pos, MSPACK_SYS_SEEK_START))
+	    /* read and copy up to 4 bytes of a null terminated string */
+	    if ((len = sys->read(fh, &buf[0], 4)) < 2) return MSPACK_ERR_READ;
+	    for (i = 0; i < len; i++) if (!(*fn++ = buf[i])) break;
+	    /* if string was 4 bytes with no null terminator, reject it */
+	    if (i == 4 && buf[3] != '\0') return MSPACK_ERR_DATAFORMAT;
+	    /* seek to byte after string ended in file */
+	    if (sys->seek(fh, (off_t)(i + 1 - len), MSPACK_SYS_SEEK_CUR))
 		return MSPACK_ERR_SEEK;
+	    fn--; /* remove the null terminator */
 	}
 	*fn = '\0';
     }
diff --git a/test/kwajd_test.c b/test/kwajd_test.c
new file mode 100644
index 0000000..4ee10f9
--- /dev/null
+++ b/test/kwajd_test.c
@@ -0,0 +1,116 @@
+/* KWAJ regression test suite */
+
+#ifdef HAVE_CONFIG_H
+#include <config.h>
+#endif
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <mspack.h>
+
+unsigned int test_count = 0;
+#define TEST(x) do {\
+    test_count++; \
+    if (!(x)) {printf("%s:%d FAILED %s\n",__FUNCTION__,__LINE__,#x);exit(1);} \
+} while (0)
+
+/* test parsing of KWAJ filename/extension headers */
+void kwajd_open_test_01() {
+    struct mskwaj_decompressor *kwajd;
+    struct mskwajd_header *hdr;
+
+    kwajd = mspack_create_kwaj_decompressor(NULL);
+    TEST(kwajd != NULL);
+
+    hdr = kwajd->open(kwajd, "test_files/kwajd/f00.kwj");
+    TEST(hdr != NULL);
+    TEST(hdr->filename == NULL);
+    kwajd->close(kwajd, hdr);
+
+#define TEST_FNAME(testfile, fname)      \
+    hdr = kwajd->open(kwajd, testfile);  \
+    TEST(hdr != NULL);                   \
+    TEST(hdr->filename != NULL);         \
+    TEST(!strcmp(fname, hdr->filename)); \
+    kwajd->close(kwajd, hdr)
+#define TEST_FNAME_BAD(testfile)         \
+    hdr = kwajd->open(kwajd, testfile);  \
+    TEST(hdr == NULL);                   \
+    TEST(kwajd->last_error(kwajd) == MSPACK_ERR_DATAFORMAT)
+
+    TEST_FNAME("test_files/kwajd/f01.kwj", ".1");
+    TEST_FNAME("test_files/kwajd/f02.kwj", ".12");
+    TEST_FNAME("test_files/kwajd/f03.kwj", ".123");
+
+    TEST_FNAME("test_files/kwajd/f10.kwj", "1");
+    TEST_FNAME("test_files/kwajd/f11.kwj", "1.1");
+    TEST_FNAME("test_files/kwajd/f12.kwj", "1.12");
+    TEST_FNAME("test_files/kwajd/f13.kwj", "1.123");
+
+    TEST_FNAME("test_files/kwajd/f20.kwj", "12");
+    TEST_FNAME("test_files/kwajd/f21.kwj", "12.1");
+    TEST_FNAME("test_files/kwajd/f22.kwj", "12.12");
+    TEST_FNAME("test_files/kwajd/f23.kwj", "12.123");
+
+    TEST_FNAME("test_files/kwajd/f30.kwj", "123");
+    TEST_FNAME("test_files/kwajd/f31.kwj", "123.1");
+    TEST_FNAME("test_files/kwajd/f32.kwj", "123.12");
+    TEST_FNAME("test_files/kwajd/f33.kwj", "123.123");
+
+    TEST_FNAME("test_files/kwajd/f40.kwj", "1234");
+    TEST_FNAME("test_files/kwajd/f41.kwj", "1234.1");
+    TEST_FNAME("test_files/kwajd/f42.kwj", "1234.12");
+    TEST_FNAME("test_files/kwajd/f43.kwj", "1234.123");
+
+    TEST_FNAME("test_files/kwajd/f50.kwj", "12345");
+    TEST_FNAME("test_files/kwajd/f51.kwj", "12345.1");
+    TEST_FNAME("test_files/kwajd/f52.kwj", "12345.12");
+    TEST_FNAME("test_files/kwajd/f53.kwj", "12345.123");
+
+    TEST_FNAME("test_files/kwajd/f60.kwj", "123456");
+    TEST_FNAME("test_files/kwajd/f61.kwj", "123456.1");
+    TEST_FNAME("test_files/kwajd/f62.kwj", "123456.12");
+    TEST_FNAME("test_files/kwajd/f63.kwj", "123456.123");
+
+    TEST_FNAME("test_files/kwajd/f70.kwj", "1234567");
+    TEST_FNAME("test_files/kwajd/f71.kwj", "1234567.1");
+    TEST_FNAME("test_files/kwajd/f72.kwj", "1234567.12");
+    TEST_FNAME("test_files/kwajd/f73.kwj", "1234567.123");
+
+    TEST_FNAME("test_files/kwajd/f80.kwj", "12345678");
+    TEST_FNAME("test_files/kwajd/f81.kwj", "12345678.1");
+    TEST_FNAME("test_files/kwajd/f82.kwj", "12345678.12");
+    TEST_FNAME("test_files/kwajd/f83.kwj", "12345678.123");
+
+    TEST_FNAME_BAD("test_files/kwajd/f04.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f14.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f24.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f34.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f44.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f54.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f64.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f74.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f84.kwj");
+
+    TEST_FNAME_BAD("test_files/kwajd/f90.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f91.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f92.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f93.kwj");
+    TEST_FNAME_BAD("test_files/kwajd/f94.kwj");
+
+
+    mspack_destroy_kwaj_decompressor(kwajd);
+}
+
+int main() {
+  int selftest;
+
+  MSPACK_SYS_SELFTEST(selftest);
+  TEST(selftest == MSPACK_ERR_OK);
+
+  kwajd_open_test_01();
+
+  printf("ALL %d TESTS PASSED.\n", test_count);
+  return 0;
+}
#diff --git a/test/test_files/kwajd/f00.kwj b/test/test_files/kwajd/f00.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..1aa817ee77bd8ec8dc617e22576d2a3d21be3130
#GIT binary patch
#literal 15
#WcmeYccl7G`pnj2ofscWK;XeQ<Uj(ZF
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f01.kwj b/test/test_files/kwajd/f01.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..9fbeddab9d31eec1958b97de12728b2c23bc6d40
#GIT binary patch
#literal 17
#YcmeYccl7G`pnj2ofuBKu!I0rU05G8h?EnA(
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f02.kwj b/test/test_files/kwajd/f02.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..a81a863b4f7d3b10ea9366de4f8fb806899dcf8a
#GIT binary patch
#literal 18
#YcmeYccl7G`pnj2oK>!F1jTrs|05vTIAOHXW
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f03.kwj b/test/test_files/kwajd/f03.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..52bfb1eb9f9381fbf2d58dfa868c1657c0ad9981
#GIT binary patch
#literal 19
#acmeYccl7G`pnj2oL6AX!!O+N<;XeR5@C8%=
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f04.kwj b/test/test_files/kwajd/f04.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..1775433bb4723694a88a9b09c794167292a8ed05
#GIT binary patch
#literal 19
#acmeYccl7G`pnj2oL5M+s!O+Oq<Uas9VFif*
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f10.kwj b/test/test_files/kwajd/f10.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..40f944bd7ff6a51afd21f40e71f3c450179ea330
#GIT binary patch
#literal 17
#YcmeYccl7G`pnj2ofuDhc!I0rU05Ew3<p2Nx
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f11.kwj b/test/test_files/kwajd/f11.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..eca53c9ec9e6945ae3699cd0bef8bd2b786309bc
#GIT binary patch
#literal 19
#ZcmeYccl7G`pnj2oL4ZMm!4L@l0{}Tu1t$Oi
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f12.kwj b/test/test_files/kwajd/f12.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..767c3550b7abe498b7be6b732b4ffa62314c7003
#GIT binary patch
#literal 20
#bcmeYccl7G`pnj2oL6AX$!H~hwh~Yl~J{bjC
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f13.kwj b/test/test_files/kwajd/f13.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..f8d7fb630f5bb714cf33ac1666ea411ec3b01318
#GIT binary patch
#literal 21
#ccmeYccl7G`pnj2oL5M+u!H~hw$e7_j07DoBjsO4v
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f14.kwj b/test/test_files/kwajd/f14.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..486e580d5ecf6d3bb188815ea11c8acc6bc40d46
#GIT binary patch
#literal 21
#ccmeYccl7G`pnj2oL6|{;!H~hw$k^mR07Huf!vFvP
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f20.kwj b/test/test_files/kwajd/f20.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..89de0effc09b5beac30b8b8d9faadc29ab616ebb
#GIT binary patch
#literal 18
#ZcmeYccl7G`pnj2oL4bjS!O)1|KL9lS1sDJT
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f21.kwj b/test/test_files/kwajd/f21.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..a4c3a8cf29bc11a58a2f262021e8f8e061ff2fb3
#GIT binary patch
#literal 20
#bcmeYccl7G`pnj2oL6AX$!O)1okl{Z7K1>B#
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f22.kwj b/test/test_files/kwajd/f22.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..fa9c35d0a9900c78a67835faea176a016d2da52b
#GIT binary patch
#literal 21
#acmeYccl7G`pnj2oL5M+u!O#eV{sRC*NCk}m
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f23.kwj b/test/test_files/kwajd/f23.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..c10cc71f5ce148cc2bfccbc5141a1ad1fa8223de
#GIT binary patch
#literal 22
#ccmeYccl7G`pnj2oL6|{;!O#eZj2Zp|07!cU!2kdN
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f24.kwj b/test/test_files/kwajd/f24.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..75858e7dd97e9a37e448abc5d85ba878026da756
#GIT binary patch
#literal 22
#ccmeYccl7G`pnj2oL4-kq!O#eZj7|On07&lz_5c6?
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f30.kwj b/test/test_files/kwajd/f30.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..e2b452e880672fecedb3937829d1200eeb7b9195
#GIT binary patch
#literal 19
#acmeYccl7G`pnj2oL6Cui!O+N<;XeR5xCKlA
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f31.kwj b/test/test_files/kwajd/f31.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..05e0ce11a1eb8eb490ab94ab78088433bbe9ea66
#GIT binary patch
#literal 21
#ccmeYccl7G`pnj2oL5M+u!O+N<!I0rU07HNUjsO4v
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f32.kwj b/test/test_files/kwajd/f32.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..96a57399057adc795770f2cd685b44ec73027789
#GIT binary patch
#literal 22
#ccmeYccl7G`pnj2oL6|{;!O+MUh#CF^07$U~!2kdN
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f33.kwj b/test/test_files/kwajd/f33.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..935d6df79e1691894ef2d35d3bb460bf4c550112
#GIT binary patch
#literal 23
#bcmeYccl7G`pnj2oL4-kq!O+MUjQ;}wP8kLD
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f34.kwj b/test/test_files/kwajd/f34.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..d7084c5c82e0661046f0d23cc6375913b7dca6fb
#GIT binary patch
#literal 23
#ccmeYccl7G`pnj2oL6kv)!O+MUgiZbf08WkuDgXcg
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f40.kwj b/test/test_files/kwajd/f40.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..64cfc84f171e642ace2ba37aa436c76cfae787de
#GIT binary patch
#literal 20
#bcmeYccl7G`pnj2oL5P8a!O+OqgyBB`KC1<R
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f41.kwj b/test/test_files/kwajd/f41.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..657177ae744dd94a47de95ae880ce727f3ce65ad
#GIT binary patch
#literal 22
#dcmeYccl7G`pnj2oL6|{;!O+Oqgu#&EKLAMX1;YRU
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f42.kwj b/test/test_files/kwajd/f42.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..6ff2b22f6f9c94f9418d58652461c575b05bb6a6
#GIT binary patch
#literal 23
#dcmeYccl7G`pnj2oL4-kq!O+Oq1V}La2LMi01@-^{
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f43.kwj b/test/test_files/kwajd/f43.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..52c6c10ba7ec12eec195a8a1ad1e3f4feaa41f16
#GIT binary patch
#literal 24
#dcmeYccl7G`pnj2oL6kv)!O+Oq1Vk|W2LMy^1}Xpm
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f44.kwj b/test/test_files/kwajd/f44.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..bc4d5106eeff2cbb97c08ebc2729675631533477
#GIT binary patch
#literal 24
#ccmeYccl7G`pnj2oL5x9y!O+Oq1Wfz~090uPUjP6A
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f50.kwj b/test/test_files/kwajd/f50.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..31bf36783cff8590e7e3c33be904538af9cede7b
#GIT binary patch
#literal 21
#ccmeYccl7G`pnj2oL70Jq!O+Oq#FXJb07KUWw*UYD
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f51.kwj b/test/test_files/kwajd/f51.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..c63c06112c681a8453423f32bb8c83331ecc5354
#GIT binary patch
#literal 23
#ecmeYccl7G`pnj2oL4-kq!O+Oq#FW91;XeRQmj(F%
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f52.kwj b/test/test_files/kwajd/f52.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..9ab97164e0c3620634156af3228f3f33a8f42ab0
#GIT binary patch
#literal 24
#ecmeYccl7G`pnj2oL6kv)!O+Oq#1u#}{09J3H3lpI
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f53.kwj b/test/test_files/kwajd/f53.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..e9736261dd771f1f5f52399d531edcf48ce297ee
#GIT binary patch
#literal 25
#ecmeYccl7G`pnj2oL5x9y!O+Oq#1up_{09J93I<>R
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f54.kwj b/test/test_files/kwajd/f54.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..f3b288749d831c586bdcfd234aa51aa3226f380a
#GIT binary patch
#literal 25
#dcmeYccl7G`pnj2oL7YK?!O+Oq#1u^a2LM`u29*E+
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f60.kwj b/test/test_files/kwajd/f60.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..af39e5828e92b7a5e23899ea426cab25f32599b7
#GIT binary patch
#literal 22
#dcmeYccl7G`pnj2oL4<*W!O+Oq#MF%8KLANR1?~U<
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f61.kwj b/test/test_files/kwajd/f61.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..a8d627831cd01649523556637bc91bde98211c71
#GIT binary patch
#literal 24
#fcmeYccl7G`pnj2oL6kv)!O+Oq#MF$zkl{Z7RD1?7
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f62.kwj b/test/test_files/kwajd/f62.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..225f8df70b4b57998a181174fe092e0ed14080b8
#GIT binary patch
#literal 25
#fcmeYccl7G`pnj2oL5x9y!O+Oq#MBH(G5iMrT2cmM
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f63.kwj b/test/test_files/kwajd/f63.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..50f79802ca6b3dffa611ac486bd47fa3a1c1dc57
#GIT binary patch
#literal 26
#fcmeYccl7G`pnj2oL7YK?!O+Oq#MBH#G5iMrU|$B8
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f64.kwj b/test/test_files/kwajd/f64.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..84c267921e5d65e03229c6a08304a78626b5be8d
#GIT binary patch
#literal 26
#ccmeYccl7G`pnj2oK>`R3jf_o9&A`-u0ASY!%m4rY
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f70.kwj b/test/test_files/kwajd/f70.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..3507550389f19581db05450f1f4311cfa1152bd4
#GIT binary patch
#literal 23
#ecmeYccl7G`pnj2oL6m`m!O+Oq#MI23;XeRQ-UcQB
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f71.kwj b/test/test_files/kwajd/f71.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..92c2141c571b38fd4b252093d404a523a81e18f9
#GIT binary patch
#literal 25
#gcmeYccl7G`pnj2oL5x9y!O+Oq#MI23!I0rU09u{~XaE2J
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f72.kwj b/test/test_files/kwajd/f72.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..a2e57ab342c435998617f13ffb31c1c9a9c7b587
#GIT binary patch
#literal 26
#gcmeYccl7G`pnj2oL7YK?!O+Oq#MI0jNHhEg0AQ^Kn*aa+
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f73.kwj b/test/test_files/kwajd/f73.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..77b1cad948681ac438877f9e46db843207e35508
#GIT binary patch
#literal 27
#ecmeYccl7G`pnj2oK>`R3jf_o9&CEeG!+!u~^9IiV
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f74.kwj b/test/test_files/kwajd/f74.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..a760b8e3314b4ac2fc7a5da642df3f1eef197fb7
#GIT binary patch
#literal 27
#fcmeYccl7G`pnj2oL6Sj&!O+Oq#MI0jO#cS}XKV)q
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f80.kwj b/test/test_files/kwajd/f80.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..b2e106f5c1e096ad5edbad2cb9c77dc3b7aca436
#GIT binary patch
#literal 24
#fcmeYccl7G`pnj2oL5zWe!O+Oq#MI2(g5f^^RJ#UW
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f81.kwj b/test/test_files/kwajd/f81.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..6f5bdddcc0dfd09808e5c09c43d084334fb46204
#GIT binary patch
#literal 26
#hcmeYccl7G`pnj2oL7YK?!O+Oq#MI2(g29mCKLB9<2B81|
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f82.kwj b/test/test_files/kwajd/f82.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..eea7493b144c2fc661c2c23269fde83eb6657d53
#GIT binary patch
#literal 27
#fcmeYccl7G`pnj2oK>`R3jf_o9&CD%;42J&zXGaFq
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f83.kwj b/test/test_files/kwajd/f83.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..161a9408ed4e48f2cba857d3a7abc0799b86bde8
#GIT binary patch
#literal 28
#hcmeYccl7G`pnj2oL6Sj&!O+Oq#MI2(0>ohW4*+e)2M7QF
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f84.kwj b/test/test_files/kwajd/f84.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..d0e02338cc28e41db5175e1b1576de51abc84f6e
#GIT binary patch
#literal 28
#gcmeYccl7G`pnj2oL5e|w!O+Oq#MI2(0?hai0B%7CJpcdz
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f90.kwj b/test/test_files/kwajd/f90.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..8605aca7a6bd739560b66d460bfb7ea9ad0099fe
#GIT binary patch
#literal 24
#fcmeYccl7G`pnj2oL7ahu!O+Oq#MI2(!ty@=RXYZm
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f91.kwj b/test/test_files/kwajd/f91.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..2fadfc7abc754e45b2dbdfe86f32cbdc7645eaaf
#GIT binary patch
#literal 26
#gcmeYccl7G`pnj2oK>`R3jf_o9&CD$<4H^Ce0Acb5+W-In
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f92.kwj b/test/test_files/kwajd/f92.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..c8a99ae9c0437b9f64fe07829ddfe828c09176db
#GIT binary patch
#literal 27
#icmeYccl7G`pnj2oL6Sj&!O+Oq#MI2(!qU));XeRqbq5Xr
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f93.kwj b/test/test_files/kwajd/f93.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..559faa9a7e5188b4da9b14fda99d9dfef1ebf8ef
#GIT binary patch
#literal 28
#icmeYccl7G`pnj2oL5e|w!O+Oq#MI2(!V<_}_zwVYF9$*Z
#
#literal 0
#HcmV?d00001
#
#diff --git a/test/test_files/kwajd/f94.kwj b/test/test_files/kwajd/f94.kwj
#new file mode 100644
#index 0000000000000000000000000000000000000000..c52dfeb0d929c3838a3d24654a4a009c527b08c7
#GIT binary patch
#literal 28
#hcmeYccl7G`pnj2oL7G8=!O+Oq#MI2(!V<*z4*+ke2X_Df
#
#literal 0
#HcmV?d00001
#
diff --git a/test/test_files/kwajd/make.pl b/test/test_files/kwajd/make.pl
new file mode 100755
index 0000000..ae73038
--- /dev/null
+++ b/test/test_files/kwajd/make.pl
@@ -0,0 +1,17 @@
+#!/usr/bin/perl -w
+use strict;
+my $name = '123456789';
+for my $file (0 .. 9) {
+    for my $ext (0 .. 4) {
+	open my $fh, '>', "f$file$ext.kwj";
+        my $offset = 14  + $file + $ext;
+	my $flags  = ($file > 0 ? 8 : 0) | ($ext > 0 ? 16 : 0);
+	print $fh pack 'A4Vvvv', 'KWAJ', 0xD127F088, 0, $offset, $flags;
+	print $fh substr $name, 0, $file if $file > 0;
+	print $fh "\0" if $file > 0 && $file < 9;
+	print $fh substr $name, 0, $ext if $ext > 0;
+	print $fh "\0" if $ext > 0 && $ext < 4;
+        print $fh "\xFF";
+	close $fh;
+    }
+}
-- 
2.18.0

