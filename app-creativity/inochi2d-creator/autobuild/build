if [[ "${CROSS:-$ARCH}" = loongson3 ]]; then
    EXTRA_FLAGS="-mabi=n64 -mcpu=mips64r2 --linker=gold"
elif [[ "${CROSS:-$ARCH}" = riscv64 ]]; then
    EXTRA_FLAGS="-Xcc=-latomic --linker=lld -mattr=+d -mabi=lp64d"
elif [[ "${CROSS:-$ARCH}" = loongarch64 ]]; then
    EXTRA_FLAGS="-g -gdwarf=5 --linker=mold"
else
    EXTRA_FLAGS="-g -gdwarf=5 --linker=lld"
fi

if [[ "$NOLTO" != 1 ]]; then
    LTO_FLAGS="-flto=full --gcc=clang"
fi

export DFLAGS="${EXTRA_FLAGS} ${LTO_FLAGS} -L-O3 -L-Wl,-build-id=sha1"

abinfo "Registering D dependencies ..."
dub add-local /usr/src/i2d-imgui 0.8.0
dub add-local /usr/src/inochi2d 0.8.3

abinfo "Generating version file ..."
cat > "$SRCDIR"/source/creator/ver.d << EOF
module creator.ver;
enum INC_VERSION = "v$PKGVER";
EOF

abinfo "Building inochi2d-creator ..."
dub fetch gitver
dub build -c linux-barebones --compiler=ldmd -y -n -b release --override-config=i2d-imgui/static_dynamicCRT

abinfo "Building translations ..."
install -dv "$PKGDIR"/usr/share/inochi-creator
for f in "$SRCDIR"/tl/*.po; do
    msgfmt -o "$PKGDIR"/usr/share/inochi-creator/"$(basename -- "$f" .po).mo" -- "$f"
done

abinfo "Installing inochi2d-creator ..."
install -Dvm755 "$SRCDIR"/out/inochi-creator -t "$PKGDIR"/usr/bin/
install -Dvm644 "$SRCDIR"/build-aux/linux/inochi-creator.desktop -t "$PKGDIR"/usr/share/applications/
install -Dvm644 "$SRCDIR"/build-aux/linux/inochi-creator.appdata.xml -t "$PKGDIR"/usr/share/metainfo/
install -Dvm644 "$SRCDIR"/res/logo_256.png "$PKGDIR"/usr/share/icons/hicolor/256x256/apps/inochi-creator.png
