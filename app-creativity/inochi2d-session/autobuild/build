if [[ "${CROSS:-$ARCH}" = loongson3 ]]; then
    EXTRA_FLAGS="-mabi=n64 -mcpu=mips64r2 --linker=gold"
elif [[ "${CROSS:-$ARCH}" = riscv64 ]]; then
    EXTRA_FLAGS="-Xcc=-latomic --linker=lld -mattr=+d -mabi=lp64d"
elif [[ "${CROSS:-$ARCH}" = loongarch64 ]]; then
    EXTRA_FLAGS="-g -gdwarf=5 --linker=mold"
else
    EXTRA_FLAGS="-g -gdwarf=5 --linker=lld"
fi

if [[ "$NOLTO" != 1 ]]; then
    LTO_FLAGS="-flto=full --gcc=clang"
fi

export DFLAGS="${EXTRA_FLAGS} ${LTO_FLAGS} -L-O3 -L-Wl,-build-id=sha1"

abinfo "Registering D dependencies ..."
dub add-local /usr/src/i2d-imgui 0.8.0
dub add-local /usr/src/lumars 1.6.1
dub add-local /usr/src/inochi2d 0.8.3

abinfo "Generating version file ..."
cat > "$SRCDIR"/source/session/ver.d << EOF
module session.ver;
enum INS_VERSION = "v$PKGVER";
EOF

abinfo "Building inochi2d-session ..."
dub fetch gitver
dub build -c linux-barebones --compiler=ldmd -y -n -b release --override-config=i2d-imgui/static_dynamicCRT

abinfo "Installing inochi2d-session ..."
install -Dvm755 "$SRCDIR"/out/inochi-session -t "$PKGDIR"/usr/bin/
install -Dvm644 "$SRCDIR"/build-aux/linux/inochi-session.desktop -t "$PKGDIR"/usr/share/applications/
install -Dvm644 "$SRCDIR"/build-aux/linux/inochi-session.appdata.xml -t "$PKGDIR"/usr/share/metainfo/
install -Dvm644 "$SRCDIR"/build-aux/linux/icon.png "$PKGDIR"/usr/share/icons/hicolor/256x256/apps/inochi-session.png
